- name: provision core vms with packer and terraform
  hosts: luxor.agartha
  become: true
  gather_facts: false
  tasks:
    - name: check if packer and terraform is installed
      shell: command -v packer && command -v terraform > /dev/null 2>&1
      register: are_deps_installed
      ignore_errors: true
      changed_when: are_deps_installed.rc != 0

    - name: install hashicorp gpg key
      shell: |
        wget -O- https://apt.releases.hashicorp.com/gpg |
        gpg --dearmor |
        sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg
      when: are_deps_installed.rc != 0

    - name: add hashicorp repo
      shell: |
        echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" |
        sudo tee /etc/apt/sources.list.d/hashicorp.list
      when: are_deps_installed.rc != 0

    - name: install terraform and packer from hashicorp repo
      apt:
        pkg:
          - terraform
          - packer
        state: latest
        update_cache: true
      when: are_deps_installed.rc != 0

    - name: push repo subdirectory to remote
      copy:
        src: ../../luxor
        dest: /home/ansible
        owner: ansible
        group: ansible
        mode: 0770

    - name: init packer and terraform
      make:
        chdir: /home/ansible/luxor
        target: init
      when: are_deps_installed.rc != 0

    - name: check if Debian VM template exists
      stat:
        path: /etc/pve/qemu-server/900.conf
      register: vm_900
      delegate_facts: true
      delegate_to: babylon.agartha

    - name: packer build
      make:
        chdir: /home/ansible/luxor/packer
        target: all
      when: not vm_900.stat.exists

    - name: enable discard and ssd emulation for template disk
      lineinfile:
        path: /etc/pve/qemu-server/900.conf
        regexp: '^scsi0'
        line: 'scsi0: ssd0:vm-900-disk-0,discard=on,iothread=1,size=16G,ssd=1'
      delegate_to: babylon.agartha

    - name: terraform provisioning
      make:
        chdir: /home/ansible/luxor/terraform
        target: all
      register: terraform_result
      changed_when: "'Resources: 0 added, 0 changed, 0 destroyed.' not in terraform_result.stdout"